# Client-aware Transfer System (CTS)

Client-aware Transfer System (CTS) 是一个智能容器镜像传输优化系统，能够感知客户端硬件配置、网络状况等能力，动态优化容器镜像的压缩与传输过程，显著提升拉取效率。

## 项目概述

### 核心问题
- 不同客户端解压能力和网络带宽差异大，统一压缩策略效率低下
- 频繁探测客户端能力带来额外开销
- 缺乏对镜像特征和客户端能力的联合决策机制

### 项目目标
智能镜像优化系统旨在通过感知客户端硬件配置、网络状况等能力，动态优化容器镜像的压缩与传输过程，提升拉取效率。

## 系统架构

### 四个功能平面
1. **感知平面**: 通过主动探针和被动网络探测获取客户端能力
2. **预测平面**: 分析镜像特征，预测最优压缩策略
3. **决策平面**: 基于成本模型或机器学习模型选择最优压缩算法
4. **执行平面**: 实现压缩、缓存、差分传输等优化机制

### 系统模块
- **capability_registry**: 节点能力画像的注册、存储和管理
- **image_probe**: 分析Docker镜像的特征，包括层结构、文件类型分布、熵值等
- **decision_engine**: 基于客户端画像和镜像特征的压缩策略决策
- **transmission_optimizer**: 传输优化策略
- **differential_sync**: 差分同步机制
- **cache_pool**: 缓存池管理
- **client_probe**: 客户端能力探测
- **feedback_collector**: 性能反馈收集
- **network_profiler**: 网络性能分析
- **probe_receiver**: 探针接收器

## 核心功能

### 1. 客户端能力探测
- 测量CPU性能、网络带宽、解压速度等指标
- 支持一次性探针注册 + 能力继承模式

### 2. 节点能力画像管理
- 生成并维护客户端能力快照，支持24小时有效期机制
- 基于IP和User-Agent生成唯一节点ID

### 3. 镜像特征分析
- 分析Docker镜像的层结构、文件类型分布、可压缩性
- 计算层熵值、文件类型分布、压缩机会评估

### 4. 自适应压缩决策
- 基于成本模型选择最优压缩算法（gzip/zstd/lz4）
- 支持多级压缩级别（gzip-1到gzip-9，zstd-1到zstd-19等）

### 5. 智能缓存机制
- 缓存已压缩镜像版本，避免重复计算
- 支持多级缓存策略

### 6. 差异化传输优化
- 支持差分传输、分块传输和带宽自适应
- 预测相关镜像，优化传输顺序

## 技术特性

### 设计模式
- **策略模式**: 用于不同压缩算法的选择与执行
- **观察者模式**: 被动网络探针监听传输行为构建画像
- **模板方法模式**: 探针测试流程标准化
- **单例模式**: 能力注册中心全局唯一实例

### 技术栈
- **后端**: Python 3.7+
- **依赖库**: 
  - docker>=6.0.0
  - zstandard>=0.19.0
  - lz4>=4.0.0
  - psutil>=5.9.0
  - py-cpuinfo>=9.0.0
- **存储**: JSON文件存储（registry/capabilities.json, local_node_profile.json）

## 使用方法

### 环境准备
```bash
pip install -r requirements.txt
```

### 1. 注册节点能力
```bash
# 注册当前机器的能力信息
python main.py --register
```

### 2. 客户端自动拉取（推荐）
```bash
# 自动检测节点能力并优化镜像拉取
python client_pull_script.py nginx:latest
```

### 3. 使用指定节点ID优化镜像
```bash
# 使用已注册的节点ID进行优化
python main.py --node-id <NODE_ID> nginx:latest
```

### 4. 运行真实场景测试
```bash
# 运行完整测试流程
python main.py --test
```

## 实验验证

### 实验设计
- 采用全因子实验设计：6客户端 × 18镜像 × 10算法 × 3重复 = 3240次执行
- 使用确定性仿真：通过`tc`命令和`cgroups`实现物理级资源限制
- 确保冷启动鲁棒性：每次实验前执行`drop_caches`清理Page Cache

### 评估指标
- 除常规误差外，定义"决策损益比"衡量模型调度质量
- 目标：90%以上决策损益比低于5%

## 数据质量保障

### 原子化写入
- 每次实验生成独立JSON文件并同步至数据库

### 数据清洗策略
- 剔除解压时间 <10ms 的异常数据
- 变异系数 CV > 15% 时标记为高变异组
- 宿主机监控：记录CPU负载用于背景噪音分析

## 扩展功能

### 机器学习模型
- 双塔MLP模型用于预测最优压缩策略
- 支持模型训练和预测

### 反馈收集机制
- 收集实际传输和解压时间用于模型优化
- 支持在线学习和模型更新

## 项目特点

1. **兼容标准Docker工作流**: 无侵入式设计，兼容现有流程
2. **被动网络探测**: 支持被动网络探测与主动探针两种能力获取方式
3. **多维度成本模型**: 总成本 = 压缩时间 + 传输时间 + 解压时间
4. **模块化设计**: 支持新增压缩算法和探针类型

## 部署方案

### 一次性注册模式
客户端注册能力后，服务端可长期使用该能力画像，减少重复探测开销。

### 容器环境被动探测模式
服务端可被动观察容器传输行为，构建节点画像，适用于容器环境。

## 已知问题与限制

- 主动探针模式在容器环境中已被废弃
- 缓存淘汰策略细节未明确说明
- 节点画像更新机制依赖手动重新注册或被动观察
- 当前不支持Web API接口（开发计划中标记为未完成）
- 机器学习优化决策尚未完全实现

## 许可证

本项目采用 MIT 许可证。# CTS_system
